name: Check OpenRouter Credits

on:
  workflow_dispatch: {}
  # schedule:
  #   - cron: "0 7 * * *"   # optional daily run at 07:00 UTC

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Query credits JSON
        id: credits
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
        run: |
          set -euo pipefail
          RESP="$(curl -sS https://openrouter.ai/api/v1/credits \
            -H "Authorization: Bearer $OPENROUTER_API_KEY")"

          echo "$RESP" > credits.json

          TOTAL_CREDITS=$(jq -r '.data.total_credits // 0' credits.json)
          TOTAL_USAGE=$(jq -r '.data.total_usage // 0' credits.json)
          REMAINING=$(jq -n --argjson tc "$TOTAL_CREDITS" --argjson tu "$TOTAL_USAGE" '$tc - $tu')

          echo "total_credits=$TOTAL_CREDITS" >> "$GITHUB_OUTPUT"
          echo "total_usage=$TOTAL_USAGE"     >> "$GITHUB_OUTPUT"
          echo "remaining=$REMaining"         >> "$GITHUB_OUTPUT"

          echo "TOTAL_CREDITS: $TOTAL_CREDITS"
          echo "TOTAL_USAGE:   $TOTAL_USAGE"
          echo "REMAINING:     $REMAINING"

      - name: Show summary
        run: |
          echo "### OpenRouter Credits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Total credits | Total usage | Remaining |" >> $GITHUB_STEP_SUMMARY
          echo "|---:|---:|---:|" >> $GITHUB_STEP_SUMMARY
          echo "| ${{ steps.credits.outputs.total_credits }} | ${{ steps.credits.outputs.total_usage }} | ${{ steps.credits.outputs.remaining }} |" >> $GITHUB_STEP_SUMMARY
