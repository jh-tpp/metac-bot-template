name: Submit Smoke Test

on:
  workflow_dispatch:
    inputs:
      test_qid:
        description: 'Test Question ID'
        required: true
        type: string
      actually_submit:
        description: 'Actually submit forecast to Metaculus'
        required: false
        type: boolean
        default: false

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.test_qid }}
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install poetry
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true
      - name: Restore AskNews cache
        uses: actions/cache@v4
        with:
          path: cache/news_cache.json
          key: asknews-cache-v2-${{ github.run_number }}
          restore-keys: |
            asknews-cache-v2-
      - name: Restore test state cache
        id: cache-test-state
        uses: actions/cache@v4
        with:
          path: .aib-test-state
          key: test-state-${{ github.event.inputs.test_qid }}
      - name: Check if already submitted
        id: check-submitted
        run: |
          if [ -f ".aib-test-state/posted_${{ github.event.inputs.test_qid }}.flag" ]; then
            echo "already_posted=true" >> $GITHUB_OUTPUT
            echo "Question ${{ github.event.inputs.test_qid }} was already submitted in a previous run"
          else
            echo "already_posted=false" >> $GITHUB_OUTPUT
          fi
      - name: Install dependencies
        if: steps.check-submitted.outputs.already_posted != 'true'
        run: poetry install --no-interaction --no-root
      - name: Run submit smoke test
        if: steps.check-submitted.outputs.already_posted != 'true'
        env:
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          METACULUS_TOKEN: ${{ github.event.inputs.actually_submit == 'true' && secrets.METACULUS_TOKEN || '' }}
        run: |
          git rev-parse --short HEAD
          if [ "${{ github.event.inputs.actually_submit }}" = "true" ]; then
            poetry run python main.py --mode submit_smoke_test --test_qid ${{ github.event.inputs.test_qid }} --publish
          else
            poetry run python main.py --mode submit_smoke_test --test_qid ${{ github.event.inputs.test_qid }}
          fi
      - name: Save posted state
        if: steps.check-submitted.outputs.already_posted != 'true' && github.event.inputs.actually_submit == 'true'
        run: |
          mkdir -p .aib-test-state
          touch ".aib-test-state/posted_${{ github.event.inputs.test_qid }}.flag"
      - name: Upload MC results
        if: always() && steps.check-submitted.outputs.already_posted != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mc-results-${{ github.event.inputs.test_qid }}
          path: mc_results.json
      - name: Upload MC reasons
        if: always() && steps.check-submitted.outputs.already_posted != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: mc-reasons-${{ github.event.inputs.test_qid }}
          path: mc_reasons.txt
      - name: Upload posted IDs
        if: always() && steps.check-submitted.outputs.already_posted != 'true' && github.event.inputs.actually_submit == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: posted-ids-${{ github.event.inputs.test_qid }}
          path: posted_ids.json
